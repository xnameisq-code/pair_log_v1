
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUR ARCHIVE - Music Player Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@300;400;700&family=Gowun+Dodum&family=Gaegu&family=Do+Hyeon&family=Song+Myung&family=Jua&display=swap" rel="stylesheet">
    
    <style>
        /* CSS ë³€ìˆ˜ */
        :root {
            --theme-color: #FFCDC9;
            --theme-light: #FFF0EE;
            --bg-color: #FFFAFA;
            --text-color: #374151;
            --main-font: 'Noto Sans KR', sans-serif;
            
            --base-font-size: 16px;
            --line-height: 1.6;
            --letter-spacing: 0px;
            --font-weight: 400;
            --font-style: normal;
        }

        body { 
            font-family: var(--main-font); background-color: var(--bg-color); color: var(--text-color);
            font-size: var(--base-font-size); line-height: var(--line-height); letter-spacing: var(--letter-spacing);
            font-weight: var(--font-weight); font-style: var(--font-style);
            overflow-x: hidden; transition: background-color 0.3s, color 0.3s;
        }

        .font-script { font-family: 'Dancing Script', cursive; }
        .font-hand { font-family: 'Nanum Pen Script', cursive; }
        .font-novel { font-family: 'Song Myung', serif; }
        .theme-text { color: var(--theme-color) !important; }
        .theme-bg { background-color: var(--theme-color) !important; }
        .hidden { display: none !important; }

        /* ë ˆì´ì•„ì›ƒ */
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #F7F7F5; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .app-container { display: flex; min-height: 100vh; max-width: 600px; margin: 0 auto; background-color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        .content-area { flex-grow: 1; padding-bottom: 40px; min-height: 100vh; background-color: #fff; overflow-y: auto; position: relative; }
        
        .tab-bar { width: 70px; background-color: #ffffff; border-left: 1px solid #f3f4f6; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 50; flex-shrink: 0; position: sticky; top: 0; height: 100vh; }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d1d5db; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; width: 100%; height: 70px; margin-bottom: 8px; }
        .tab-item.active { color: var(--theme-color); font-weight: bold; }
        .tab-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 60%; background-color: var(--theme-color); border-radius: 0 4px 4px 0; }
        .tab-icon { font-size: 1.4rem; margin-bottom: 4px; transition: transform 0.2s; }
        .tab-item:hover .tab-icon { transform: scale(1.1); }
        .tab-content { display: none; padding: 24px; animation: fadeIn 0.3s ease-out; min-height: 100%; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* ìŠ¤íƒ€ì¼ */
        .fab-btn { position: fixed; bottom: 30px; right: 90px; width: 50px; height: 50px; background-color: var(--theme-color); color: #374151; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 40; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1) rotate(90deg); }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.8); z-index: 100; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s; 
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }

        .upload-modal-box { background: white; width: 90%; max-width: 320px; padding: 20px; border-radius: 16px; text-align: center; transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.open .upload-modal-box { transform: translateY(0); }
        
        .full-screen-modal-box { background: white; width: 100%; height: 100%; max-width: 600px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .modal-overlay.open .full-screen-modal-box { transform: translateY(0); }
        
        .novel-page-container { width: 100%; height: 100%; background-color: #fff; padding: 40px 30px; overflow-y: auto; }

        /* ì§„í–‰ë°” */
        .progress-bar-bg { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 10px; position: relative; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: var(--theme-color); transition: width 1s ease-in-out; width: 0%; border-radius: 9999px; }
        .percent-tooltip { position: absolute; top: -30px; left:0; transform: translateX(-50%); background-color: var(--theme-color); color: #374151; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; white-space: nowrap; transition: left 1s ease-in-out; }
        .percent-tooltip::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid var(--theme-color); }

        /* íƒ­ë³„ ìŠ¤íƒ€ì¼ */
        .profile-img-container { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; background-color: #f3f4f6; cursor: pointer; }
        .main-photo-frame { width: 100%; aspect-ratio: 4 / 3; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); position: relative; background-color: #f3f4f6; cursor: pointer; }
        
        .album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding-bottom: 60px; }
        .polaroid { background: white; padding: 8px 8px 35px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; cursor: pointer; }
        .polaroid:hover { transform: scale(1.05) rotate(1deg); z-index: 10; }
        .polaroid-img { width: 100%; aspect-ratio: 3 / 4; object-fit: cover; background: #eee; }
        
        .memo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding-bottom: 60px; }
        .memo-card { background: var(--theme-light); padding: 20px 15px; border-radius: 4px; position: relative; min-height: 140px; cursor: pointer; background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); background-size: 15px 15px; display: flex; flex-direction: column; }
        .memo-tape { position: absolute; top: -8px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 40%; height: 18px; background: rgba(255,255,255,0.4); backdrop-filter: blur(2px); }
        .memo-content { font-family: var(--main-font); font-size: 0.9rem; flex-grow: 1; margin-bottom: 10px; white-space: pre-wrap; word-break: break-all; line-height: 1.5; }
        .memo-footer { border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #6b7280; }

        /* ì‘ì„±ì í”„ë¡œí•„ ë¯¸ë‹ˆ */
        .author-mini-box { display: flex; align-items: center; gap: 6px; }
        .author-mini-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); background-color: #ddd; }
        .author-mini-name { font-weight: bold; color: var(--text-color); font-size: 0.75rem; }

        .book-container { padding: 10px 10px 80px 10px; }
        .book-header { text-align: center; margin-bottom: 60px; padding-top: 20px; border-bottom: 2px double var(--theme-color); padding-bottom: 40px; }
        .book-title { font-family: 'Song Myung', serif; font-size: 3rem; color: #1f2937; margin-bottom: 10px; }
        .book-subtitle { font-family: 'Song Myung', serif; color: var(--theme-color); letter-spacing: 3px; font-size: 0.9rem; }
        .novel-chapter { margin-bottom: 60px; cursor: pointer; position: relative; }
        .chapter-header { text-align: center; margin-bottom: 20px; }
        .chapter-title { font-family: 'Song Myung', serif; font-size: 1.8rem; font-weight: bold; margin-bottom: 6px; text-align: center; }
        .chapter-meta { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 20px; opacity: 0.6; font-size: 0.8rem; }
        .chapter-content { font-family: 'Song Myung', serif; font-size: 1.1rem; line-height: 2.0; text-align: justify; white-space: pre-wrap; padding: 0 10px; }
        .chapter-divider { text-align: center; color: var(--theme-color); font-size: 1.2rem; margin: 40px 0; opacity: 0.6; }

        .music-list { display: flex; flex-direction: column; gap: 20px; padding-bottom: 60px; }
        .music-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; }
        .music-video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
        .music-video-wrapper iframe { position: absolute; top:0; left:0; width:100%; height:100%; }
        .music-info { padding: 16px; display: flex; flex-direction: column; gap: 8px; background-color: #fff; }
        .music-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .music-recommender { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #9ca3af; background: #f9fafb; padding: 4px 8px; border-radius: 12px; align-self: flex-start; }

        .tmi-list { display: flex; flex-direction: column; gap: 20px; padding-bottom: 60px; padding-left: 10px; padding-right: 10px; }
        .tmi-card { background-color: #fff; border: 1px solid #e5e7eb; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); position: relative; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E"); cursor: pointer; transition: transform 0.2s; }
        .tmi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .tmi-tape { position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(1deg); width: 80px; height: 24px; background-color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.1); backdrop-filter: blur(2px); opacity: 0.8; }
        .tmi-header { font-family: 'Song Myung', serif; font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; color: #1f2937; letter-spacing: 1px; }
        .tmi-content { font-family: var(--main-font); font-size: 0.95rem; line-height: 1.8; color: #4b5563; text-align: center; white-space: pre-wrap; margin-bottom: 20px; }
        .tmi-footer { display: flex; justify-content: space-between; align-items: flex-end; font-size: 0.75rem; color: #9ca3af; }

        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-option.selected { border: 2px solid #374151; transform: scale(1.1); }
        .font-option { padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .font-option.selected { border-color: var(--theme-color); background-color: var(--theme-light); }
        .style-toggle { padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 20px; cursor: pointer; transition: all 0.2s; background-color: white; font-size: 0.9rem; color: #6b7280; margin-right: 8px; }
        .style-toggle.active { background-color: var(--theme-color); color: #374151; border-color: var(--theme-color); font-weight: bold; }
        input[type=range] { width: 100%; accent-color: var(--theme-color); cursor: pointer; }
        input[type=color] { width: 50px; height: 40px; border: none; background: none; cursor: pointer; }
        .lightbox-img { max-width: 95%; max-height: 70vh; border-radius: 4px; }
        .setting-section { margin-bottom: 30px; }
        .setting-title { font-size: 1rem; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: #374151; }

        /* í”„ë¡œí•„ íƒ­ ì „ìš© ìŠ¤íƒ€ì¼ */
        .profile-container { height: 100%; display: flex; flex-direction: column; }
        .profile-view-area { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .profile-header-img { width: 100%; aspect-ratio: 16/9; border-radius: 12px; object-fit: cover; background-color: #f3f4f6; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .profile-input-name { text-align: center; width: 100%; font-size: 1.5rem; font-weight: bold; margin-top: 20px; background: transparent; border: none; outline: none; border-bottom: 1px solid transparent; transition: 0.3s; }
        .profile-input-name:focus { border-bottom: 1px solid var(--theme-color); }
        .profile-input-desc { width: 100%; text-align: center; margin-top: 15px; background: transparent; border: none; outline: none; resize: none; min-height: 100px; font-size: 0.9rem; color: #6b7280; line-height: 1.8; }
        .profile-bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; display: flex; border-top: 1px solid #f3f4f6; background: white; }
        .profile-sub-tab { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #9ca3af; cursor: pointer; transition: 0.3s; background: #fff; }
        .profile-sub-tab:hover { background-color: #f9fafb; }
        .profile-sub-tab.active { color: var(--text-color); font-weight: bold; border-top: 2px solid var(--theme-color); background-color: var(--theme-light); }
        .profile-sub-tab input { background: transparent; border: none; text-align: center; width: 80%; outline: none; cursor: pointer; }
        
        .identity-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; border: 1px solid #e5e7eb; margin-bottom: 20px; }
        .identity-badge.active { background-color: var(--theme-color); color: white; border-color: var(--theme-color); font-weight: bold; }

        /* [NEW] í”„ë¡œí•„ ë®¤ì§ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .music-player-card {
            background-color: #f5f5f5; /* Light Gray like image */
            border-radius: 24px;
            padding: 24px 16px;
            width: 220px;
            margin: 0 auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .music-circle-mask {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* iframeì´ ì›ì„ ê½‰ ì±„ìš°ë„ë¡ */
        .music-circle-mask iframe {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            transform: scale(1.35); /* ì•½ê°„ í™•ëŒ€í•´ì„œ ë ˆí„°ë°•ìŠ¤ ì œê±° */
        }
        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            width: 100%;
            margin-bottom: 10px;
        }
        .control-btn {
            color: #9ca3af;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1.2rem;
        }
        .control-btn:hover { color: #374151; }
        .play-btn {
            font-size: 1.8rem;
            color: #4b5563;
        }
        .play-btn:hover { color: #1f2937; transform: scale(1.1); }
        
        .player-progress-bar {
            width: 80%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            position: relative;
        }
        .player-progress-fill {
            width: 30%; /* ì¥ì‹ìš© ê³ ì • */
            height: 100%;
            background-color: #9ca3af;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 flex justify-center">

    <div id="login-screen" class="auth-screen">
        <h1 class="font-script text-6xl text-gray-800 mb-2">Our Archive</h1>
        <p class="text-gray-500 mb-8 font-novel">ë‘˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ ê¸°ë¡í•˜ì„¸ìš”.</p>
        <button id="google-login-btn" class="flex items-center gap-3 bg-white border border-gray-300 px-6 py-3 rounded-lg shadow-sm hover:bg-gray-50 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            <span class="font-medium">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</span>
        </button>
    </div>

    <div id="connect-screen" class="auth-screen hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold mb-2 font-novel">í˜ì–´ ì—°ê²°</h2>
            <p class="text-gray-500 mb-6 text-sm">í•¨ê»˜ ê³µìœ í•  ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•˜ê±°ë‚˜<br>ìƒˆë¡œìš´ ì½”ë“œë¥¼ ë§Œë“œì„¸ìš”.</p>
            <div class="mb-6">
                <label class="block text-left text-xs font-bold text-gray-400 mb-1">PAIR CODE</label>
                <input type="text" id="pair-code-input" placeholder="LOVE-1234" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-3 text-center text-lg font-bold tracking-widest uppercase focus:outline-none focus:border-black transition">
                <p class="text-xs text-gray-400 mt-2 text-left">* 3ê¸€ì ì´ìƒ ì…ë ¥</p>
            </div>
            <button id="connect-btn" class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="app-screen" class="app-container w-full hidden">
        <div class="content-area">
            
            <div id="tab-main" class="tab-content active">
                <div class="text-center mb-8 pt-6">
                    <input type="text" id="main-title" class="font-script text-5xl theme-text drop-shadow-sm text-center bg-transparent outline-none w-full placeholder-opacity-50" value="lovemore" onchange="saveMeta('title', this.value)">
                    <input type="text" id="main-subtitle" class="text-xs text-gray-400 mt-2 tracking-widest uppercase text-center bg-transparent outline-none w-full" value="Love log" onchange="saveMeta('subtitle', this.value)">
                </div>
                <div class="flex items-center justify-between px-2 mb-10">
                    <div class="flex flex-col items-center opacity-60 pointer-events-none">
                        <div class="profile-img-container">
                            <img id="main-char-a-img" src="https://via.placeholder.com/150/e5e7eb/9ca3af?text=A" class="w-full h-full object-cover">
                        </div>
                        <span id="main-char-a-name" class="mt-3 text-xs font-bold text-center w-20 truncate">Name A</span>
                    </div>
                    <div class="flex flex-col items-center justify-center -mt-4 mx-2">
                        <i class="fas fa-heart theme-text text-xl animate-pulse mb-1"></i>
                        <span id="d-day-display" class="text-lg font-bold text-gray-700">D+0</span>
                        <input type="date" id="start-date" class="mt-1 text-[10px] bg-transparent text-gray-400 border rounded px-1 outline-none" onchange="saveMeta('startDate', this.value); calculateDDay()">
                    </div>
                    <div class="flex flex-col items-center opacity-60 pointer-events-none">
                         <div class="profile-img-container">
                            <img id="main-char-b-img" src="https://via.placeholder.com/150/e5e7eb/9ca3af?text=B" class="w-full h-full object-cover">
                        </div>
                         <span id="main-char-b-name" class="mt-3 text-xs font-bold text-center w-20 truncate">Name B</span>
                    </div>
                </div>
                <div class="mb-12 px-2">
                    <div class="flex justify-between text-xs text-gray-400 mb-2 font-medium">
                        <span id="progress-start-label">Start</span><span id="progress-end-label">100 Days</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="anniversary-bar" class="progress-bar-fill"></div>
                        <div id="percent-tooltip" class="percent-tooltip" style="left: 0%">0%</div>
                    </div>
                    <p id="remaining-days-text" class="text-center text-[10px] text-gray-400 mt-3">ë‹¤ìŒ ê¸°ë…ì¼ê¹Œì§€ í•¨ê»˜ ë‹¬ë ¤ê°€ëŠ” ì¤‘! ğŸƒâ€â™‚ï¸</p>
                </div>
                <div class="mb-8">
                    <div class="main-photo-frame group" onclick="document.getElementById('file-main-photo').click()">
                        <img id="img-main-photo" src="https://via.placeholder.com/400x300/f3f4f6/d1d5db?text=Touch+to+Add+Photo" class="w-full h-full object-cover">
                        <input type="file" id="file-main-photo" class="hidden" accept="image/*" onchange="uploadImage(this, 'img-main-photo', 'mainPhoto', 800)">
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content" style="padding:0; height:100%; display:none;">
                <div class="profile-container">
                    <div class="profile-view-area">
                        <div class="text-center w-full">
                            <button id="identity-btn" class="identity-badge" onclick="toggleMyIdentity()">
                                <i class="fas fa-check-circle"></i> <span>ì´ í”„ë¡œí•„ì„ 'ë‚˜'ë¡œ ì‚¬ìš©í•˜ê¸°</span>
                            </button>
                            <p class="text-[10px] text-gray-400 mb-4">* ê¸€ ì‘ì„± ì‹œ ì´ë¦„ê³¼ ì‚¬ì§„ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="w-full flex justify-center mb-6">
                            <div class="w-full aspect-[4/5] max-w-[280px] rounded-xl overflow-hidden bg-gray-100 relative shadow-md group cursor-pointer" onclick="document.getElementById('file-profile-header').click()">
                                <img id="profile-header-img" src="https://via.placeholder.com/300x400/f3f4f6/d1d5db?text=Profile+Photo" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                    <i class="fas fa-camera text-white opacity-0 group-hover:opacity-100 transition text-2xl"></i>
                                </div>
                                <input type="file" id="file-profile-header" class="hidden" accept="image/*" onchange="uploadProfileImage(this)">
                            </div>
                        </div>
                        <div class="flex flex-col items-center mb-8 px-4">
                            <input type="text" id="profile-name-input" class="profile-input-name" placeholder="NAME" onchange="saveCurrentProfile('name', this.value)">
                            <textarea id="profile-desc-input" class="profile-input-desc" placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." onchange="saveCurrentProfile('desc', this.value)"></textarea>
                        </div>
                        
                        <div class="w-full px-4 mb-20">
                            <div class="text-xs text-gray-400 font-bold mb-4 text-center tracking-widest">THEME SONG</div>
                            <input type="text" id="profile-song-url" class="w-full text-center text-xs border-b border-gray-200 py-1 outline-none mb-6 bg-transparent placeholder-gray-300" placeholder="YouTube URL ì…ë ¥" onchange="updateProfileSong(this.value)">
                            
                            <div id="profile-player-container" class="music-player-card hidden">
                                <div class="music-circle-mask">
                                    <div id="youtube-player-placeholder"></div>
                                </div>
                                <div class="player-controls">
                                    <i class="fas fa-step-backward control-btn" onclick="seekPlayer(-10)"></i>
                                    <i id="player-play-btn" class="fas fa-play play-btn" onclick="togglePlay()"></i>
                                    <i class="fas fa-step-forward control-btn" onclick="seekPlayer(10)"></i>
                                </div>
                                <div class="player-progress-bar">
                                    <div class="player-progress-fill"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-bottom-nav">
                        <div id="sub-tab-a" class="profile-sub-tab active" onclick="switchProfileSub('A')">
                            <input type="text" id="tab-name-a" value="Profile A" onchange="saveMeta('tabNameA', this.value); event.stopPropagation();" onclick="this.focus(); event.stopPropagation();">
                        </div>
                        <div id="sub-tab-b" class="profile-sub-tab" onclick="switchProfileSub('B')">
                            <input type="text" id="tab-name-b" value="Profile B" onchange="saveMeta('tabNameB', this.value); event.stopPropagation();" onclick="this.focus(); event.stopPropagation();">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-album" class="tab-content">
                <h2 class="font-script text-3xl mb-6 text-center theme-text">Photo Album</h2>
                <div id="album-grid" class="album-grid"></div>
                <div class="fab-btn" onclick="openUploadModal()"><i class="fas fa-plus"></i></div>
            </div>

            <div id="tab-memo" class="tab-content">
                <h2 class="font-script text-3xl mb-6 text-center theme-text">Memo Pad</h2>
                <div id="memo-grid" class="memo-grid"></div>
                <div class="fab-btn" onclick="openMemoModal()"><i class="fas fa-plus"></i></div>
            </div>

            <div id="tab-log" class="tab-content">
                <div class="book-container">
                    <div class="book-header"><h1 class="book-title">Our Story</h1><p class="book-subtitle">ìš°ë¦¬ì˜ ëª¨ë“  ìˆœê°„</p></div>
                    <div id="novel-book-body"></div>
                    <div class="fab-btn" onclick="openLogModal()"><i class="fas fa-pen-nib"></i></div>
                </div>
            </div>

            <div id="tab-playlist" class="tab-content">
                <h2 class="font-script text-3xl mb-6 text-center theme-text">Our Playlist</h2>
                <div id="playlist-container" class="music-list"></div>
                <div class="fab-btn" onclick="openMusicModal()"><i class="fas fa-music"></i></div>
            </div>

            <div id="tab-tmi" class="tab-content">
                <h2 class="font-script text-3xl mb-6 text-center theme-text">TMI</h2>
                <div id="tmi-list" class="tmi-list"></div>
                <div class="fab-btn" onclick="openTmiModal()"><i class="fas fa-plus"></i></div>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2 class="text-2xl font-bold mb-6 theme-text"><i class="fas fa-cog mr-2"></i>ì„¤ì •</h2>
                <div class="setting-section">
                    <div class="setting-title"><i class="fas fa-palette"></i> í…Œë§ˆ ìƒ‰ìƒ</div>
                    <div class="color-palette">
                        <div class="color-option selected" style="background:#FFCDC9" data-theme="strawberry" onclick="changeTheme('strawberry', this)"></div>
                        <div class="color-option" style="background:#C6E7FF" data-theme="cloud" onclick="changeTheme('cloud', this)"></div>
                        <div class="color-option" style="background:#CDC1FF" data-theme="grape" onclick="changeTheme('grape', this)"></div>
                        <div class="color-option" style="background:#CBCBCB" data-theme="mono" onclick="changeTheme('mono', this)"></div>
                    </div>
                </div>
                <div class="setting-section">
                    <div class="setting-title"><i class="fas fa-font"></i> ê¸€ì”¨ì²´</div>
                    <div id="font-options">
                        <div class="font-option selected" onclick="changeFont('Noto Sans KR', this)">Noto Sans KR</div>
                        <div class="font-option" onclick="changeFont('Gowun Dodum', this)">ê³ ìš´ë‹ì›€</div>
                        <div class="font-option" onclick="changeFont('Do Hyeon', this)">ë„í˜„ì²´</div>
                        <div class="font-option" onclick="changeFont('Song Myung', this)">ì†¡ëª…</div>
                        <div class="font-option" onclick="changeFont('Jua', this)">ì£¼ì•„ì²´</div>
                    </div>
                </div>
                <div class="setting-section">
                    <div class="setting-title"><i class="fas fa-sliders-h"></i>í…ìŠ¤íŠ¸ ì¡°ì •</div>
                    <div class="flex gap-2 mb-4">
                        <button id="btn-bold" class="style-toggle" onclick="toggleStyle('bold', this)">Bold</button>
                        <button id="btn-italic" class="style-toggle" onclick="toggleStyle('italic', this)">Italic</button>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 block mb-1">í¬ê¸° (<span id="size-val">16px</span>)</label>
                        <input id="input-size" type="range" min="12" max="24" value="16" oninput="updateTypography('size', this.value)">
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 block mb-1">ìê°„ (<span id="spacing-val">0px</span>)</label>
                        <input id="input-spacing" type="range" min="-2" max="10" value="0" step="0.5" oninput="updateTypography('spacing', this.value)">
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 block mb-1">í–‰ê°„ (<span id="height-val">1.6</span>)</label>
                        <input id="input-height" type="range" min="1.0" max="3.0" value="1.6" step="0.1" oninput="updateTypography('height', this.value)">
                    </div>
                </div>
                <div class="setting-section">
                    <div class="setting-title"><i class="fas fa-fill-drip"></i>ê¸€ì ìƒ‰ìƒ</div>
                    <div class="flex items-center gap-4">
                        <input type="color" id="text-color-picker" value="#374151" onchange="updateTypography('color', this.value)">
                        <span class="text-sm text-gray-400">í´ë¦­í•˜ì—¬ ìƒ‰ìƒ ë³€ê²½</span>
                    </div>
                </div>
                <div class="mt-10 pt-6 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-400 font-bold">CREATED BY CODE</p>
                    <a href="https://twitter.com/100D0R" target="_blank" class="text-xs text-blue-400 hover:underline">@100D0R</a>
                    <button id="logout-btn" class="block mx-auto mt-4 text-xs text-red-400 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <div class="mt-8 pt-6 border-t border-red-100">
                    <button id="btn-reset-dream" onclick="resetDream()" class="w-full bg-red-50 text-red-500 py-3 rounded-lg text-sm font-bold hover:bg-red-100 transition shadow-sm border border-red-100">
                        <i class="fas fa-exclamation-triangle mr-2"></i>ë“œë¦¼ ì‚­ì œ ë° ì´ˆê¸°í™”
                    </button>
                    <p class="text-[10px] text-gray-400 text-center mt-2">ëª¨ë“  ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" onclick="switchTab('main')"><i class="fas fa-home tab-icon"></i><span>Main</span></div>
            <div class="tab-item" onclick="switchTab('profile')"><i class="fas fa-user-circle tab-icon"></i><span>Profile</span></div>
            <div class="tab-item" onclick="switchTab('album')"><i class="fas fa-images tab-icon"></i><span>Album</span></div>
            <div class="tab-item" onclick="switchTab('memo')"><i class="fas fa-sticky-note tab-icon"></i><span>Memo</span></div>
            <div class="tab-item" onclick="switchTab('log')"><i class="fas fa-file-alt tab-icon"></i><span>Log</span></div>
            <div class="tab-item" onclick="switchTab('playlist')"><i class="fas fa-music tab-icon"></i><span>Music</span></div>
            <div class="tab-item" onclick="switchTab('tmi')"><i class="fas fa-info-circle tab-icon"></i><span>TMI</span></div>
            <div class="tab-item" onclick="switchTab('settings')"><i class="fas fa-cog tab-icon"></i><span>Set</span></div>
        </div>
    </div>

    <div id="upload-modal" class="modal-overlay hidden">
        <div class="upload-modal-box">
            <h3 id="upload-modal-title" class="font-bold mb-2">ì¶”ì–µ ê¸°ë¡</h3>
            <input type="hidden" id="photo-id"><input type="hidden" id="photo-edit-mode" value="false"><input type="hidden" id="existing-photo-base64">
            <div class="w-full aspect-[3/4] bg-gray-100 rounded mb-4 overflow-hidden relative border border-dashed border-gray-300 cursor-pointer" onclick="document.getElementById('modal-file-input').click()">
                <img id="modal-preview" class="w-full h-full object-cover hidden">
                <div id="modal-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400"><i class="fas fa-camera text-2xl mb-2"></i><span class="text-xs">ì„ íƒ</span></div>
            </div>
            <input type="file" id="modal-file-input" class="w-full text-xs mb-2" accept="image/*" onchange="modalPreview(this)">
            <div class="flex gap-2"><button onclick="closeModal('upload-modal')" class="flex-1 bg-gray-100 py-2 rounded">ì·¨ì†Œ</button><button id="btn-save-polaroid" onclick="savePolaroid()" class="flex-1 bg-black text-white py-2 rounded">ë“±ë¡</button></div>
        </div>
    </div>

    <div id="memo-modal" class="modal-overlay hidden">
        <div class="upload-modal-box">
            <h3 id="memo-modal-title" class="font-bold mb-2">ë©”ëª¨</h3>
            <input type="hidden" id="memo-id">
            <div class="mb-4 text-left"><label class="text-xs text-gray-500">ë‚´ìš©</label><textarea id="memo-content-input" class="w-full border p-2 mb-2 text-sm h-24"></textarea></div>
            <div class="flex gap-2"><button onclick="closeModal('memo-modal')" class="flex-1 bg-gray-100 py-2 rounded">ì·¨ì†Œ</button><button onclick="deleteMemo()" id="memo-delete-btn" class="hidden flex-1 bg-red-100 text-red-500 py-2 rounded">ì‚­ì œ</button><button id="btn-save-memo" onclick="saveMemo()" class="flex-1 bg-black text-white py-2 rounded">ì €ì¥</button></div>
        </div>
    </div>

    <div id="music-modal" class="modal-overlay hidden">
        <div class="upload-modal-box">
            <h3 id="music-modal-title" class="font-bold mb-2">ìŒì•…</h3>
            <input type="hidden" id="music-id">
            <div class="mb-3 text-left"><label class="text-xs text-gray-500">ì œëª©</label><input type="text" id="music-title-input" class="w-full border p-2 mb-2"></div>
            <div class="mb-3 text-left"><label class="text-xs text-gray-500">ê°€ìˆ˜</label><input type="text" id="music-artist-input" class="w-full border p-2 mb-2"></div>
            <div class="mb-4 text-left"><label class="text-xs text-gray-500">URL</label><input type="text" id="music-url-input" class="w-full border p-2 mb-2"></div>
            <div class="flex gap-2"><button onclick="closeModal('music-modal')" class="flex-1 bg-gray-100 rounded">ì·¨ì†Œ</button><button onclick="deleteMusic()" id="music-delete-btn" class="hidden flex-1 bg-red-100 text-red-500 rounded">ì‚­ì œ</button><button id="btn-save-music" onclick="saveMusic()" class="flex-1 bg-black text-white rounded">ì €ì¥</button></div>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay hidden">
        <div class="full-screen-modal-box">
            <div class="novel-page-container">
                <div class="novel-header-deco"><span class="novel-part-label" id="log-part-label">PART</span></div>
                <input type="text" id="log-title-input" class="novel-title-input" placeholder="ì œëª©">
                <textarea id="log-content-input" class="novel-content-input" placeholder="ë‚´ìš©..."></textarea>
                <div class="novel-footer"><span id="log-date-display">-</span></div>
                <input type="hidden" id="log-id">
                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                    <button onclick="closeModal('log-modal')" class="text-gray-400 text-sm">ë‹«ê¸°</button>
                    <div class="flex gap-3"><button onclick="deleteLog()" class="hidden text-red-400 text-sm" id="log-delete-btn">ì‚­ì œ</button><button id="btn-save-log" onclick="saveLog()" class="theme-text font-bold text-sm">ì €ì¥</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tmi-modal" class="modal-overlay hidden">
        <div class="upload-modal-box">
            <h3 id="tmi-modal-title" class="text-lg font-bold mb-4 font-novel">TMI Card</h3>
            <input type="hidden" id="tmi-id">
            <div class="mb-4 text-left"><label class="text-xs text-gray-500">ë‚´ìš©</label><textarea id="tmi-content-input" class="w-full border p-2 text-sm h-32 resize-none"></textarea></div>
            <div class="flex gap-2">
                <button onclick="closeModal('tmi-modal')" class="flex-1 bg-gray-100 py-2 rounded">ì·¨ì†Œ</button>
                <button onclick="deleteTmi()" id="tmi-delete-btn" class="hidden flex-1 bg-red-100 text-red-500 py-2 rounded">ì‚­ì œ</button>
                <button id="btn-save-tmi" onclick="saveTmi()" class="flex-1 bg-black text-white py-2 rounded">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="lightbox-modal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal('lightbox-modal')">
        <div class="flex flex-col items-center gap-4">
            <img id="lightbox-img" class="lightbox-img">
            <div class="flex gap-2"><button onclick="editPhoto()" class="bg-white text-gray-800 px-4 py-2 rounded-full shadow">ì‚¬ì§„ ë³€ê²½</button><button onclick="deletePhoto()" class="bg-red-500 text-white px-4 py-2 rounded-full shadow">ì‚­ì œ</button><button onclick="closeModal('lightbox-modal')" class="bg-gray-600 text-white px-4 py-2 rounded-full shadow">ë‹«ê¸°</button></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAa2SXQ5M5BEVInNSYMn-ZdRAG7D9x1goE",
            authDomain: "pair-log-system.firebaseapp.com",
            projectId: "pair-log-system",
            storageBucket: "pair-log-system.firebasestorage.app",
            messagingSenderId: "870583876096",
            appId: "1:870583876096:web:e882d3c6f062a4e239f6e5",
            measurementId: "G-YKWTHY0EG3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser=null, myPairCode=null, currentPhotoId=null, unsubLogs=null, unsubMeta=null;
        let currentProfileTab = 'A'; 
        let myIdentity = null; 
        const screens = { login: document.getElementById('login-screen'), connect: document.getElementById('connect-screen'), app: document.getElementById('app-screen') };

        // [NEW] YouTube API Load
        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player;
        let isPlayerReady = false;

        function onYouTubeIframeAPIReady() {
            // API Loaded, wait for init call
            isPlayerReady = true;
        }

        // Auth
        document.getElementById('google-login-btn').addEventListener('click', () => {
             auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()))
                .catch(e => alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e.message));
        });

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                screens.login.classList.add('hidden');
                screens.connect.classList.remove('hidden');
            } else {
                if(unsubLogs) unsubLogs(); if(unsubMeta) unsubMeta(); 
                currentUser = null; myPairCode = null; myIdentity = null;
                screens.login.classList.remove('hidden');
                screens.connect.classList.add('hidden');
                screens.app.classList.add('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().then(()=>location.reload()));
        document.getElementById('connect-btn').addEventListener('click', async () => {
            const code = document.getElementById('pair-code-input').value.trim().toUpperCase();
            if (code.length < 3) return alert("3ê¸€ì ì´ìƒ ì…ë ¥.");
            try { 
                await db.collection('users').doc(currentUser.uid).set({email:currentUser.email, pairCode:code}, {merge:true}); 
                myPairCode=code; 
                initApp(); 
            } catch(e){alert("ì˜¤ë¥˜:"+e.message);}
        });

        async function initApp() { 
            screens.connect.classList.add('hidden'); 
            screens.app.classList.remove('hidden'); 
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if(userDoc.exists && userDoc.data().role) myIdentity = userDoc.data().role;
            loadMeta(); 
            loadLogs(); 
        }

        let coupleData = {}; 
        let cachedLogs = []; 

        function loadMeta() {
            if(unsubMeta) unsubMeta();
            unsubMeta = db.collection('couples').doc(myPairCode).onSnapshot(doc => {
                if(doc.exists) {
                    coupleData = doc.data();
                    const d = coupleData;
                    if(d.title) document.getElementById('main-title').value=d.title;
                    if(d.subtitle) document.getElementById('main-subtitle').value=d.subtitle;
                    if(d.startDate) { document.getElementById('start-date').value=d.startDate; calculateDDay(); }
                    if(d.mainPhoto) document.getElementById('img-main-photo').src=d.mainPhoto;
                    if(d.profileA) document.getElementById('main-char-a-img').src=d.profileA;
                    if(d.profileB) document.getElementById('main-char-b-img').src=d.profileB;
                    if(d.nameA) document.getElementById('main-char-a-name').innerText=d.nameA;
                    if(d.nameB) document.getElementById('main-char-b-name').innerText=d.nameB;
                    if(d.tabNameA) document.getElementById('tab-name-a').value = d.tabNameA;
                    if(d.tabNameB) document.getElementById('tab-name-b').value = d.tabNameB;
                    
                    renderProfileContent();
                    renderLogs(cachedLogs);

                    if(d.theme) changeTheme(d.theme, document.querySelector(`.color-option[data-theme="${d.theme}"]`)||document.querySelector('.color-option'));
                    if(d.font) changeFont(d.font, document.querySelector(`.font-option[data-font="${d.font}"]`)||document.querySelector('.font-option'));
                    if(d.textSize) updateTypography('size', d.textSize);
                    if(d.lineHeight) updateTypography('height', d.lineHeight);
                    if(d.letterSpacing) updateTypography('spacing', d.letterSpacing);
                    if(d.textColor) updateTypography('color', d.textColor);
                    if(d.fontWeight) { document.documentElement.style.setProperty('--font-weight', d.fontWeight); if(d.fontWeight==='700') document.getElementById('btn-bold').classList.add('active'); }
                    if(d.fontStyle) { document.documentElement.style.setProperty('--font-style', d.fontStyle); if(d.fontStyle==='italic') document.getElementById('btn-italic').classList.add('active'); }
                    if(d.textSize) document.getElementById('input-size').value = parseInt(d.textSize);
                    if(d.lineHeight) document.getElementById('input-height').value = d.lineHeight;
                    if(d.letterSpacing) document.getElementById('input-spacing').value = parseInt(d.letterSpacing);
                    if(d.textColor) document.getElementById('text-color-picker').value = d.textColor;
                }
            });
            db.collection('couples').doc(myPairCode).collection('assets').onSnapshot(snap => {
                snap.forEach(doc => {
                    const key = doc.id; const val = doc.data().image;
                    if(key === 'mainPhoto') document.getElementById('img-main-photo').src = val;
                });
            });
        }

        // Profile Logic
        function switchProfileSub(type) {
            currentProfileTab = type;
            document.querySelectorAll('.profile-sub-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('sub-tab-' + type.toLowerCase()).classList.add('active');
            renderProfileContent();
        }

        function renderProfileContent() {
            const suffix = currentProfileTab; 
            const img = coupleData['profile' + suffix] || 'https://via.placeholder.com/300x400/f3f4f6/d1d5db?text=Profile+Photo';
            const name = coupleData['name' + suffix] || '';
            const desc = coupleData['desc' + suffix] || '';
            const song = coupleData['song' + suffix] || '';
            document.getElementById('profile-header-img').src = img;
            document.getElementById('profile-name-input').value = name;
            document.getElementById('profile-desc-input').value = desc;
            document.getElementById('profile-song-url').value = song;
            
            // [NEW] Call Player Update
            updatePlayer(song);
            
            updateIdentityBadge();
        }

        function saveCurrentProfile(field, value) { saveMeta(field + currentProfileTab, value); }
        function updateProfileSong(url) { saveCurrentProfile('song', url); updatePlayer(url); }

        // [NEW] YouTube Player Logic with API
        function updatePlayer(url) {
            const container = document.getElementById('profile-player-container');
            let v = '';
            if(url) {
                if(url.includes('v=')) v = url.split('v=')[1].substring(0,11);
                else if(url.includes('youtu.be/')) v = url.split('youtu.be/')[1].substring(0,11);
            }

            if(v) {
                container.classList.remove('hidden');
                if(player && typeof player.loadVideoById === 'function') {
                    player.loadVideoById(v);
                } else {
                    // Create Player
                    // Need to wait slightly if API isn't fully ready, but usually on page load it is.
                    // If div replaced, create new on the ID
                    if(document.getElementById('youtube-player-placeholder')) {
                        player = new YT.Player('youtube-player-placeholder', {
                            height: '100%',
                            width: '100%',
                            videoId: v,
                            playerVars: {
                                'playsinline': 1,
                                'controls': 0, // Hide default controls
                                'modestbranding': 1
                            },
                            events: {
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    }
                }
            } else {
                container.classList.add('hidden');
                if(player && typeof player.stopVideo === 'function') player.stopVideo();
            }
        }

        function togglePlay() {
            if(!player) return;
            const state = player.getPlayerState();
            if(state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function seekPlayer(seconds) {
            if(!player) return;
            const currentTime = player.getCurrentTime();
            player.seekTo(currentTime + seconds, true);
        }

        function onPlayerStateChange(event) {
            const btn = document.getElementById('player-play-btn');
            if (event.data == YT.PlayerState.PLAYING) {
                btn.classList.remove('fa-play');
                btn.classList.add('fa-pause');
            } else {
                btn.classList.remove('fa-pause');
                btn.classList.add('fa-play');
            }
        }

        function uploadProfileImage(input) {
            if(input.files[0]) {
                const assetName = 'profile' + currentProfileTab;
                compressImage(input.files[0], 600, 0.7, async(b) => {
                    document.getElementById('profile-header-img').src = b;
                    await db.collection('couples').doc(myPairCode).collection('assets').doc(assetName).set({image:b});
                    await db.collection('couples').doc(myPairCode).set({[assetName]: b}, {merge:true});
                });
            }
        }

        async function toggleMyIdentity() {
            if(myIdentity === currentProfileTab) alert("ì´ë¯¸ ë‚´ í”„ë¡œí•„ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            else if(confirm(`í˜„ì¬ íƒ­(${currentProfileTab})ì„ ë‚˜ì˜ í”„ë¡œí•„ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                myIdentity = currentProfileTab;
                await db.collection('users').doc(currentUser.uid).set({role: myIdentity}, {merge:true});
                updateIdentityBadge();
            }
        }

        function updateIdentityBadge() {
            const btn = document.getElementById('identity-btn');
            if(myIdentity === currentProfileTab) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-check-circle"></i> <span>í˜„ì¬ ë‚´ í”„ë¡œí•„ì…ë‹ˆë‹¤</span>'; } 
            else { btn.classList.remove('active'); btn.innerHTML = '<i class="far fa-circle"></i> <span>ì´ í”„ë¡œí•„ì„ \'ë‚˜\'ë¡œ ì‚¬ìš©í•˜ê¸°</span>'; }
        }

        function getMyInfo() {
            if(!myIdentity) return { name: 'Unknown', profile: '', role: null };
            return {
                name: coupleData['name' + myIdentity] || 'Anonymous',
                profile: coupleData['profile' + myIdentity] || '',
                role: myIdentity
            };
        }

        const escapeStr = (str) => str ? str.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n') : '';

        function getLogDisplayInfo(log) {
            let role = log.authorRole;
            let name = log.author;
            let img = 'https://via.placeholder.com/30?text=?';
            if (!role && log.author) {
                if (log.author === coupleData.nameA) role = 'A';
                else if (log.author === coupleData.nameB) role = 'B';
            }
            if (role === 'A') {
                name = coupleData.nameA || name;
                img = coupleData.profileA || img;
            } else if (role === 'B') {
                name = coupleData.nameB || name;
                img = coupleData.profileB || img;
            }
            return { name, img };
        }

        function loadLogs() {
            if(unsubLogs) unsubLogs();
            unsubLogs = db.collection('logs').where('pairCode','==',myPairCode).onSnapshot(snap => {
                const logs=[]; snap.forEach(d=>logs.push({id:d.id, ...d.data()}));
                logs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                cachedLogs = logs; 
                renderLogs(logs);
            });
        }

        function renderLogs(logs) {
            const album=document.getElementById('album-grid'), memo=document.getElementById('memo-grid'), pl=document.getElementById('playlist-container'), novel=document.getElementById('novel-book-body'), tmi=document.getElementById('tmi-list');
            album.innerHTML=''; memo.innerHTML=''; pl.innerHTML=''; novel.innerHTML=''; tmi.innerHTML='';
            
            let count=0;
            const novels=logs.filter(l=>l.type==='novel').reverse();
            
            logs.filter(l=>l.type!=='novel').forEach(l=>{
                const info = getLogDisplayInfo(l); 
                
                if(l.type==='photo') {
                    album.innerHTML+=`<div class="polaroid" onclick="viewPhoto('${l.id}','${l.image}')"><img src="${l.image}" class="polaroid-img"></div>`;
                }
                else if(l.type==='memo') {
                    memo.innerHTML+=`
                    <div class="memo-card" onclick="editMemo('${l.id}','${escapeStr(l.text)}')">
                        <div class="memo-tape"></div>
                        <div class="memo-content">${l.text}</div>
                        <div class="memo-footer">
                            <span>${l.dateStr}</span>
                            <div class="author-mini-box">
                                <img src="${info.img}" class="author-mini-img">
                                <span class="author-mini-name">${info.name}</span>
                            </div>
                        </div>
                    </div>`;
                }
                else if(l.type==='music') {
                    pl.innerHTML+=`
                    <div class="music-card">
                        <div class="music-video-wrapper"><iframe src="https://www.youtube.com/embed/${l.videoId}" frameborder="0"></iframe></div>
                        <div class="music-info">
                            <div class="music-top-row">
                                <h3 class="font-bold text-gray-800 text-lg">${l.title}</h3>
                                <div class="flex gap-2">
                                    <button onclick="editMusic('${l.id}','${escapeStr(l.title)}','${escapeStr(l.artist)}','${l.videoId}')"><i class="fas fa-edit text-gray-400"></i></button>
                                    <button onclick="deleteMusic('${l.id}')"><i class="fas fa-trash text-red-300"></i></button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">${l.artist}</div>
                            <div class="music-recommender">
                                <img src="${info.img}" class="author-mini-img" style="width:20px;height:20px;">
                                <span>${info.name}ë‹˜ì˜ ì¶”ì²œ</span>
                            </div>
                        </div>
                    </div>`;
                }
                else if(l.type==='tmi') {
                    tmi.innerHTML+=`
                    <div class="tmi-card" onclick="editTmi('${l.id}','${escapeStr(l.text)}')">
                        <div class="tmi-tape"></div>
                        <div class="tmi-header">TMI</div>
                        <div class="tmi-content">${l.text}</div>
                        <div class="tmi-footer">
                            <div class="author-mini-box">
                                <img src="${info.img}" class="author-mini-img">
                                <span class="author-mini-name">${info.name}</span>
                            </div>
                            <span>${l.dateStr}</span>
                        </div>
                    </div>`;
                }
            });

            novels.forEach(l => {
                const info = getLogDisplayInfo(l);
                novel.innerHTML+=`
                <div class="novel-chapter" onclick="editLog('${l.id}','${escapeStr(l.title)}','${escapeStr(l.text)}')">
                    <div class="chapter-header">
                        <span class="text-xs text-theme-color font-novel">Chapter ${++count}</span>
                        <h2 class="chapter-title">${l.title}</h2>
                        <div class="chapter-meta">
                            <img src="${info.img}" class="author-mini-img" style="width:20px;height:20px;">
                            <span>${info.name}</span>
                            <span>|</span>
                            <span>${l.dateStr}</span>
                        </div>
                    </div>
                    <div class="chapter-content">${l.text}</div>
                    <div class="chapter-divider">âœ»</div>
                </div>`;
            });
        }

        // Logic
        function compressImage(file, maxWidth, quality, callback) {
            const reader=new FileReader(); reader.readAsDataURL(file);
            reader.onload=e=>{ const img=new Image(); img.src=e.target.result;
                img.onload=()=>{ const c=document.createElement('canvas'); let w=img.width, h=img.height; if(w>maxWidth){h=Math.round(h*(maxWidth/w)); w=maxWidth;} c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); callback(c.toDataURL('image/jpeg',quality)); }
            };
        }
        async function saveMeta(k,v){ try{ await db.collection('couples').doc(myPairCode).set({[k]:v},{merge:true}); }catch(e){console.error(e);} }
        function uploadImage(i,d,f,w=600){ if(i.files[0]) compressImage(i.files[0],w,0.7,async(b)=>{ document.getElementById(d).src=b; await db.collection('couples').doc(myPairCode).collection('assets').doc(f).set({image:b}); await db.collection('couples').doc(myPairCode).set({[f]: b}, {merge:true}); }); }
        function calculateDDay(){ const v=document.getElementById('start-date').value; if(!v)return; const d=Math.floor((new Date()-new Date(v))/(1000*60*60*24)); document.getElementById('d-day-display').innerText=`D+${d+1}`; const n=Math.ceil((d+1)/100)*100; document.getElementById('progress-start-label').innerText=`D+${n-100}`; document.getElementById('progress-end-label').innerText=`D+${n}`; const p=((d+1)-(n-100))/100*100; document.getElementById('anniversary-bar').style.width=`${p}%`; document.getElementById('percent-tooltip').style.left=`${p}%`; document.getElementById('percent-tooltip').innerText=`${Math.round(p)}%`; }
        function switchTab(t){ document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); if(t === 'profile') document.getElementById('tab-'+t).style.display = 'block'; else document.getElementById('tab-profile').style.display = 'none'; document.querySelectorAll('.tab-item').forEach(i=>i.classList.remove('active')); event.currentTarget.classList.add('active'); }
        
        // Modal Helpers
        function closeModal(id){ const m=document.getElementById(id); m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); }
        function openModal(id){ const m=document.getElementById(id); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('open'),10); }
        
        // Album
        function openUploadModal(){ openModal('upload-modal'); document.getElementById('upload-modal-title').innerText='ì¶”ì–µ ê¸°ë¡'; document.getElementById('photo-edit-mode').value='false'; document.getElementById('photo-id').value=''; document.getElementById('existing-photo-base64').value=''; document.getElementById('modal-file-input').value=''; document.getElementById('modal-preview').classList.add('hidden'); document.getElementById('modal-placeholder').classList.remove('hidden'); document.getElementById('btn-save-polaroid').innerText='ë“±ë¡'; }
        function savePolaroid(){
            const f=document.getElementById('modal-file-input').files[0], isEdit=document.getElementById('photo-edit-mode').value==='true', id=document.getElementById('photo-id').value, ex=document.getElementById('existing-photo-base64').value;
            const save=async(img)=>{ try{ if(isEdit) await db.collection('logs').doc(id).update({image:img}); else await db.collection('logs').add({pairCode:myPairCode, type:'photo', image:img, text:'', createdAt:new Date()}); closeModal('upload-modal'); }catch(e){alert("ì‹¤íŒ¨:"+e.message);} };
            if(f) compressImage(f,800,0.7,save); else if(isEdit) save(ex); else alert('ì‚¬ì§„ í•„ìš”');
        }
        function viewPhoto(id,src){ currentPhotoId=id; document.getElementById('lightbox-img').src=src; openModal('lightbox-modal'); }
        function editPhoto(){ closeModal('lightbox-modal'); openUploadModal(); document.getElementById('upload-modal-title').innerText='ì‚¬ì§„ ë³€ê²½'; document.getElementById('photo-edit-mode').value='true'; document.getElementById('photo-id').value=currentPhotoId; document.getElementById('existing-photo-base64').value=document.getElementById('lightbox-img').src; document.getElementById('modal-preview').src=document.getElementById('lightbox-img').src; document.getElementById('modal-preview').classList.remove('hidden'); document.getElementById('modal-placeholder').classList.add('hidden'); document.getElementById('btn-save-polaroid').innerText='ìˆ˜ì • ì™„ë£Œ'; }
        async function deletePhoto(){ if(confirm('ì‚­ì œ?')){ await db.collection('logs').doc(currentPhotoId).delete(); closeModal('lightbox-modal'); } }
        
        // Memo (Updated)
        function openMemoModal(){ openModal('memo-modal'); document.getElementById('memo-modal-title').innerText='ìƒˆ ë©”ëª¨'; document.getElementById('memo-id').value=''; document.getElementById('memo-content-input').value=''; document.getElementById('memo-delete-btn').classList.add('hidden'); }
        function editMemo(id,t){ openModal('memo-modal'); document.getElementById('memo-modal-title').innerText='ë©”ëª¨ ìˆ˜ì •'; document.getElementById('memo-id').value=id; document.getElementById('memo-content-input').value=t; document.getElementById('memo-delete-btn').classList.remove('hidden'); }
        async function saveMemo(){
            const id=document.getElementById('memo-id').value, t=document.getElementById('memo-content-input').value;
            if(!t) return alert('ë‚´ìš© ì…ë ¥');
            const info = getMyInfo();
            if(!id && (!info.role)) return alert('í”„ë¡œí•„ íƒ­ì—ì„œ ë‚´ í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
            const d={pairCode:myPairCode, type:'memo', text:t, dateStr:new Date().toLocaleDateString(), createdAt:new Date()};
            if(!id) { d.author = info.name; d.authorRole = info.role; await db.collection('logs').add(d); }
            else await db.collection('logs').doc(id).update({text:t});
            closeModal('memo-modal');
        }
        async function deleteMemo(){ const id=document.getElementById('memo-id').value; if(id && confirm('ì‚­ì œ?')) await db.collection('logs').doc(id).delete(); closeModal('memo-modal'); }
        
        // Log (Updated)
        function openLogModal(){ openModal('log-modal'); document.getElementById('log-id').value=''; document.getElementById('log-title-input').value=''; document.getElementById('log-content-input').value=''; document.getElementById('log-date-display').innerText='-'; document.getElementById('log-delete-btn').classList.add('hidden'); }
        function editLog(id,t,c){ openModal('log-modal'); document.getElementById('log-id').value=id; document.getElementById('log-title-input').value=t; document.getElementById('log-content-input').value=c; document.getElementById('log-delete-btn').classList.remove('hidden'); }
        async function saveLog(){
            const id=document.getElementById('log-id').value, t=document.getElementById('log-title-input').value, c=document.getElementById('log-content-input').value;
            if(!t || !c) return alert('ì…ë ¥ í™•ì¸');
            const info = getMyInfo();
            if(!id && (!info.role)) return alert('í”„ë¡œí•„ íƒ­ì—ì„œ ë‚´ í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
            const d={pairCode:myPairCode, type:'novel', title:t, text:c, dateStr:new Date().toLocaleDateString(), createdAt:new Date()};
            if(!id) { d.author = info.name; d.authorRole = info.role; await db.collection('logs').add(d); }
            else await db.collection('logs').doc(id).update({title:t, text:c});
            closeModal('log-modal');
        }
        async function deleteLog(){ const id=document.getElementById('log-id').value; if(id && confirm('ì‚­ì œ?')) await db.collection('logs').doc(id).delete(); closeModal('log-modal'); }

        // Music (Updated)
        function openMusicModal(){ openModal('music-modal'); document.getElementById('music-id').value=''; document.getElementById('music-title-input').value=''; document.getElementById('music-artist-input').value=''; document.getElementById('music-url-input').value=''; document.getElementById('music-delete-btn').classList.add('hidden'); }
        function editMusic(id,t,a,v){ openModal('music-modal'); document.getElementById('music-id').value=id; document.getElementById('music-title-input').value=t; document.getElementById('music-artist-input').value=a; document.getElementById('music-url-input').value='https://youtu.be/'+v; document.getElementById('music-delete-btn').classList.remove('hidden'); }
        async function saveMusic(){
            const u=document.getElementById('music-url-input').value, t=document.getElementById('music-title-input').value, a=document.getElementById('music-artist-input').value, id=document.getElementById('music-id').value;
            let v=''; if(u.includes('v=')) v=u.split('v=')[1].substring(0,11); else if(u.includes('youtu.be/')) v=u.split('youtu.be/')[1].substring(0,11);
            if(!t || !v) return alert('í•„ìˆ˜ ì…ë ¥');
            const info = getMyInfo();
            if(!id && (!info.role)) return alert('í”„ë¡œí•„ íƒ­ì—ì„œ ë‚´ í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
            const d={pairCode:myPairCode, type:'music', title:t, artist:a, videoId:v, createdAt:new Date()};
            if(!id) { d.author = info.name; d.authorRole = info.role; await db.collection('logs').add(d); }
            else await db.collection('logs').doc(id).update({title:t, artist:a, videoId:v});
            closeModal('music-modal');
        }
        async function deleteMusic(id){ if(id && confirm('ì‚­ì œ?')) await db.collection('logs').doc(id).delete(); closeModal('music-modal'); }

        // TMI (Updated)
        function openTmiModal(){ openModal('tmi-modal'); document.getElementById('tmi-id').value=''; document.getElementById('tmi-content-input').value=''; document.getElementById('tmi-delete-btn').classList.add('hidden'); }
        function editTmi(id,t){ openModal('tmi-modal'); document.getElementById('tmi-id').value=id; document.getElementById('tmi-content-input').value=t; document.getElementById('tmi-delete-btn').classList.remove('hidden'); }
        async function saveTmi(){
            const id=document.getElementById('tmi-id').value, t=document.getElementById('tmi-content-input').value;
            if(!t) return alert('ë‚´ìš© ì…ë ¥');
            const info = getMyInfo();
            if(!id && (!info.role)) return alert('í”„ë¡œí•„ íƒ­ì—ì„œ ë‚´ í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
            const d={pairCode:myPairCode, type:'tmi', text:t, dateStr:new Date().toLocaleDateString(), createdAt:new Date()};
            if(!id) { d.author = info.name; d.authorRole = info.role; await db.collection('logs').add(d); }
            else await db.collection('logs').doc(id).update({text:t});
            closeModal('tmi-modal');
        }
        async function deleteTmi(){ const id=document.getElementById('tmi-id').value; if(id && confirm('ì‚­ì œ?')) await db.collection('logs').doc(id).delete(); closeModal('tmi-modal'); }

        async function resetDream(){ if(confirm("ì´ˆê¸°í™”?")){ const s=await db.collection('logs').where('pairCode','==',myPairCode).get(); s.forEach(d=>d.ref.delete()); const a=await db.collection('couples').doc(myPairCode).collection('assets').get(); a.forEach(d=>d.ref.delete()); await db.collection('couples').doc(myPairCode).delete(); await db.collection('users').doc(currentUser.uid).update({pairCode:firebase.firestore.FieldValue.delete(), role: firebase.firestore.FieldValue.delete()}); location.reload(); } }

        function changeTheme(t,e){ const r=document.documentElement.style; document.querySelectorAll('.color-option').forEach(o=>o.classList.remove('selected')); e.classList.add('selected'); saveMeta('theme',t); if(t=='strawberry'){r.setProperty('--theme-color','#FFCDC9');r.setProperty('--bg-color','#FFFAFA');} if(t=='cloud'){r.setProperty('--theme-color','#C6E7FF');r.setProperty('--bg-color','#F8FCFF');} if(t=='grape'){r.setProperty('--theme-color','#CDC1FF');r.setProperty('--bg-color','#FAF9FF');} if(t=='mono'){r.setProperty('--theme-color','#CBCBCB');r.setProperty('--bg-color','#FAFAFA');} }
        function changeFont(n,e){ document.documentElement.style.setProperty('--main-font',n); document.querySelectorAll('.font-option').forEach(o=>o.classList.remove('selected')); e.classList.add('selected'); saveMeta('font',n); }
        function updateTypography(t,v){ const r=document.documentElement.style; if(t=='size'){r.setProperty('--base-font-size',v+'px'); saveMeta('textSize',v);} else if(t=='height'){r.setProperty('--line-height',v); saveMeta('lineHeight',v);} else if(t=='spacing'){r.setProperty('--letter-spacing',v+'px'); saveMeta('letterSpacing',v);} else if(t=='color'){r.setProperty('--text-color',v); saveMeta('textColor',v);} }
        function toggleStyle(s,b){ const r=document.documentElement.style; b.classList.toggle('active'); const a=b.classList.contains('active'); if(s=='bold'){r.setProperty('--font-weight',a?'700':'400'); saveMeta('fontWeight',a?'700':'400');} else{r.setProperty('--font-style',a?'italic':'normal'); saveMeta('fontStyle',a?'italic':'normal');} }
        function modalPreview(i){ if(i.files[0]) compressImage(i.files[0],600,0.7,b=>{document.getElementById('modal-preview').src=b; document.getElementById('modal-preview').classList.remove('hidden'); document.getElementById('modal-placeholder').classList.add('hidden');}); }
    </script>
</body>
</html>
